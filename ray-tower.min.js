#!/usr/bin/env node
const{sucide,murder,homocide}=require("sucide"),flags=require("ray-flags"),path=require("path"),port=5432|+flags.p,version="v1.0.2",resourceDir="requestedResources";if(flags.v)sucide(version);else if(!1|flags.init){const a=Object.assign({},require("ray-fs"));null==flags.N&&sucide("Please provide the Name of the Tower!"),null==flags.V&&sucide("Please provide the Version of the Tower!"),null==flags.p&&sucide("Please provide the Port of the Tower!"),a.writeJSON("config.json",{TOWER_NAME:flags.N,TOWER_VERSION:flags.V,TOWER_PORT:port,TOWER_TYPE:`ray-tower ${version}`,PUBLIC_TOWERS:[]}),a.writeJSON("towers.json",{TOWER_NAME:flags.N,TOWER_VERSION:flags.V}),sucide("Ray-Tower Initialized!")}else if(!1|flags.pair){const b=Object.assign({},require("ray-fs")),c="towers.json",d="config.json";homocide(flags.N,"Please provide the Name of the new Tower!"),homocide(flags.ip,"Please provide the IP of the new Tower!"),homocide(flags.p,"Please provide the IP of the new Tower!");const e={name:flags.N,ip:flags.ip,port:flags.p};function modJSON(s){return void 0===s.towers&&(s.towers=[]),s.towers.push({name:e.name,ip:e.ip,port:e.port}),s}b.exists(c).value||sucide(`No ${c} file exists!`),b.updateJSON(c,modJSON),!1|flags.public&&b.updateJSON(d,modJSON),sucide("New Tower paired!")}else if(flags.boot){const g=require("express"),h=g(),i=require("node-fetch"),path=require("path"),j=Object.assign({},require("ray-fs"));j.initDir(resourceDir);const k=j.readJSON("config.json").value,l=j.readJSON("towers.json").value;h.get("/",(e,s)=>{s.sendFile(path.join(process.cwd(),"config.json"))}),h.get("/request/:requestObject",(e,s)=>{const{breadCrumbs:r,requestedResource:o}=JSON.parse(e.params.requestObject),t=r[0]+"//"+r.slice(1).join("/");!async function(){var e=await i(t);j.stream(e.body,path.join(resourceDir,o))}();e={requestStatus:"Your request is in Process.",accessTowerNode:"/fetch/"+t};s.status(202).send(e)}),h.get("/fetch/:responseObject",(e,s)=>{e=JSON.parse(e.params.responseObject);console.log(e);e=path.join(resourceDir,e.file);j.exists(e).value?s.sendFile(path.join(process.cwd(),e)):s.status(404)}),h.listen(k.TOWER_PORT)}